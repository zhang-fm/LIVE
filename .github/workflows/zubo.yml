name: Grab Multicast Sources from cqshushu

on:
  schedule:
    - cron: "0 8 * * *"          # 每天北京时间 8:00 运行一次（JST 9:00）
  workflow_dispatch:             # 支持网页手动触发

jobs:
  grab-and-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1. 检出仓库
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      # 2. 设置 Python 环境
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3. 安装依赖（requests + 其他常用库）
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      # 4. 运行抓取脚本（假设你的脚本文件名为 grab_multicast.py）
      - name: Run multicast grabber script
        run: python grab_multicast.py
        env:
          # 可选：如果需要设置代理或其他环境变量
          # HTTP_PROXY: ${{ secrets.HTTP_PROXY }}

      # 5. 防止冲突：先 pull 最新
      - name: Pull latest changes
        run: |
          git fetch origin
          git pull origin main --rebase || git pull origin main --no-rebase || echo "pull 失败，继续"

      # 6. Commit & Push 生成的文件
      - name: Commit and push grabbed files
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # 添加所有生成的 m3u 文件（test_multicast/ 目录下）
          git add test_multicast/*.m3u || true
          
          # 检查是否有变更
          git status --short
          
          if git diff --cached --quiet; then
            echo "⚠️ 没有新抓取的文件，跳过 commit & push"
            exit 0
          fi
          
          # commit
          git commit -m "自动抓取组播源更新 - $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          
          # push（带防冲突）
          git push origin HEAD:main || {
            echo "push 失败，尝试 rebase 后重试"
            git pull origin main --rebase
            git push origin HEAD:main || echo "⚠️ 最终推送失败，请检查"
          }

      # 7. 总结输出（可选，便于日志查看）
      - name: Show results
        if: always()
        run: |
          echo "=== 抓取结果总结 ==="
          if [ -d "test_multicast" ]; then
            ls -l test_multicast/ || echo "目录为空"
            find test_multicast/ -name "*.m3u" -exec wc -l {} \; || echo "无 m3u 文件"
          else
            echo "未生成 test_multicast 目录"
          fi
