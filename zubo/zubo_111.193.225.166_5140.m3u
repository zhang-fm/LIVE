<?php
// å¨ä»»ä½è¾åºä¹åå¯å¨sessionåå¤çä¸è½½
session_start();

// è·ååæ°
$limit = isset($_GET['limit']) ? max(1, min(20, (int)$_GET['limit'])) : 6;
$type = isset($_GET['type']) ? $_GET['type'] : 'all';
$province = isset($_GET['province']) ? $_GET['province'] : 'all';
$refresh = isset($_GET['refresh']) ? true : false;
$s = isset($_GET['s']) ? $_GET['s'] : '';
$p = isset($_GET['p']) ? $_GET['p'] : '';
$getIps = isset($_GET['getips']) ? true : false;

// æä¹åè°ç¨æ¬¡æ°ç»è®¡ï¼åå­æ´æ°ï¼
$callCount = 0;
$counterFile = __DIR__ . '/iptv_multithread.counter';
if (!file_exists($counterFile)) {
    // åå§åæä»¶
    @file_put_contents($counterFile, "0", LOCK_EX);
}
$fp = @fopen($counterFile, 'c+');
if ($fp) {
    if (@flock($fp, LOCK_EX)) {
        $current = (int)trim(stream_get_contents($fp));
        $current++;
        $callCount = $current;
        rewind($fp);
        ftruncate($fp, 0);
        fwrite($fp, (string)$current);
        fflush($fp);
        flock($fp, LOCK_UN);
    }
    fclose($fp);
}

// å¦ææpåæ°ï¼åè§£æè·åå®æ´çip:portï¼ç¶åè·³è½¬å°s=ip:port
if (!empty($p)) {
    // å¼å¥è§£æå¨
    require_once 'iptv_parser.php';
    
    // è§£æIPè·åå®æ´ä¿¡æ¯
    $result = getHotelIptvInfo($p);
    
    if ($result['success'] && !empty($result['data'])) {
        $firstIpPort = $result['data'][0]['ip_port'];
        // è·³è½¬å°å®æ´çsåæ°
        header("Location: " . $_SERVER['PHP_SELF'] . "?s=" . urlencode($firstIpPort));
        exit;
    } else {
        // å¦æè§£æå¤±è´¥ï¼ä»ç¶è·³è½¬å°såæ°ï¼è®©åç»­é»è¾å¤çéè¯¯
        header("Location: " . $_SERVER['PHP_SELF'] . "?s=" . urlencode($p));
        exit;
    }
}


function extractIP($input) {
    // å¦æåå«åå·ï¼åæååå·åçé¨å
    if (strpos($input, ':') !== false) {
        return explode(':', $input)[0];
    }
    // å¦æä¸åå«åå·ï¼ç´æ¥è¿ååå¼
    return $input;
}

// å¦ææåä¸ªIPæ¥è¯¢æé¢éåè¡¨æ¥è¯¢
if (!empty($s)) {
    // å¦æè¯·æ±é¢éåè¡¨ä¸è½½ï¼ä¼åå¤ç
    if (isset($_GET['channels']) && isset($_GET['download'])) {
        require_once 'iptv_channels.php';
        
        // è·åé¢éåè¡¨
        $channelsResult = getIptvChannelList($s, false);
        
        if ($channelsResult['success']) {
            $filename = 'iptv-' . str_replace([':'], '-', $s);
            
            if ($_GET['download'] === 'txt') {
                $output = "";
                if (isset($channelsResult['source_info'])) {
                    $info = $channelsResult['source_info'];
                    $output .= "# æ¥æº: {$info['provider']} - {$info['type']} ({$info['ip_port']}) byå¬ä¼å·|å»å·¥å­¦ä¹ æ¥å¿\n";
                    $output .= "# æ»é¢éæ°: {$info['total_channels']}\n";
                    $output .= "\n";
                }
                foreach ($channelsResult['data'] as $channel) {
                    $output .= "{$channel['name']},{$channel['url']}\n";
                }
                
                // æ¸é¤ä»»ä½è¾åºç¼å²
                while (ob_get_level()) {
                    ob_end_clean();
                }
                
                header('Content-Type: text/plain; charset=utf-8');
                header('Content-Disposition: attachment; filename="' . $filename . '.txt"');
                header('Content-Length: ' . strlen($output));
                header('Cache-Control: no-cache, must-revalidate');
                header('Pragma: no-cache');
                header('Expires: 0');
                echo $output;
                exit;
            } elseif ($_GET['download'] === 'm3u') {
                $output = "#EXTM3U\n";
                $output .= "#EXT-X-VERSION:3\n";
                if (isset($channelsResult['source_info'])) {
                    $info = $channelsResult['source_info'];
                    $output .= "# æ¥æº: {$info['provider']} - {$info['type']} ({$info['ip_port']})  byå¬ä¼å·|å»å·¥å­¦ä¹ æ¥å¿\n";
                    $output .= "# æ»é¢éæ°: {$info['total_channels']}\n";
                }
                $output .= "\n";
                
                foreach ($channelsResult['data'] as $channel) {
                    $output .= "#EXTINF:-1,{$channel['name']}\n";
                    $output .= "{$channel['url']}\n";
                }
                
                // æ¸é¤ä»»ä½è¾åºç¼å²
                while (ob_get_level()) {
                    ob_end_clean();
                }
                
                header('Content-Type: application/vnd.apple.mpegurl; charset=utf-8');
                header('Content-Disposition: attachment; filename="' . $filename . '.m3u"');
                header('Content-Length: ' . strlen($output));
                header('Cache-Control: no-cache, must-revalidate');
                header('Pragma: no-cache');
                header('Expires: 0');
                echo $output;
                exit;
            }
        }
    }
    
    // è¾åºHTMLå¼å¤´
    echo '<!DOCTYPE html>';
    echo '<html lang="zh-CN">';
    echo '<head>';
    echo '<meta charset="UTF-8">';
    echo '<meta name="viewport" content="width=device-width, initial-scale=1.0">';
    echo '<title>IPTVç¥å¨Pro</title>';
    echo '<style>';
    echo 'body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }';
    echo '.container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }';
    echo 'h1 { color: #333; text-align: center; border-bottom: 3px solid #007bff; padding-bottom: 10px; }';
    echo '.controls { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; display: flex; align-items: center; flex-wrap: wrap; gap: 15px; }';
    echo '.stats { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-around; }';
    echo '.stat-item { text-align: center; }';
    echo '.stat-number { font-size: 1.5em; font-weight: bold; display: block; }';
    echo '.group-section { margin-bottom: 20px; border: 1px solid #ddd; border-radius: 5px; overflow: hidden; }';
    echo '.group-header { padding: 15px; font-weight: bold; color: white; margin: 0; }';
    echo '.group-header.proxy { background: #ff6b6b; }';
    echo '.iptv-table { width: 100%; border-collapse: collapse; }';
    echo '.iptv-table th { background: #f8f9fa; padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6; }';
    echo '.iptv-table td { padding: 10px; border-bottom: 1px solid #dee2e6; }';
    echo '.iptv-table tr:hover { background: #f8f9fa; }';
    echo '.ip-link { color: #007bff; text-decoration: none; font-weight: 500; }';
    echo '.ip-link:hover { text-decoration: underline; }';
    echo '.status-badge { padding: 3px 6px; border-radius: 10px; font-size: 0.85em; }';
    echo '.status-new { background: #d4edda; color: #155724; }';
    echo '.status-alive { background: #fff3cd; color: #856404; }';
    echo '.status-failed { background: #f8d7da; color: #721c24; }';
    echo '.error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 4px; margin: 20px 0; }';
    // é¢éåè¡¨é¡µé¢ä¸ç¨CSS
    echo '.channels-page .iptv-table { border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }';
    echo '.channels-page .iptv-table th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: bold; }';
    echo '.channels-page .iptv-table tr:nth-child(even) { background: #f8f9fa; }';
    echo '.channels-page .iptv-table tr:hover { background: #e3f2fd; transform: translateY(-1px); transition: all 0.2s ease; }';
    echo '.download-section { text-align: center; margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }';
    echo '.download-section h4 { margin-bottom: 20px; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.3); font-size: 1.2em; }';
    echo '.download-btn { background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%); color: white; padding: 12px 24px; border-radius: 25px; text-decoration: none; margin: 5px; display: inline-block; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: none; cursor: pointer; }';
    echo '.download-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }';
    echo '.download-btn.txt { background: linear-gradient(135deg, #fd7e14 0%, #ff9500 100%); }';
    echo '.download-btn.m3u { background: linear-gradient(135deg, #6f42c1 0%, #8e44ad 100%); }';
    echo '.download-tip { margin-top: 15px; font-size: 0.9em; color: rgba(255,255,255,0.9); text-shadow: 0 1px 2px rgba(0,0,0,0.2); }';
    echo '.action-buttons { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; }';
    echo '.btn { padding: 5px 10px; border: none; border-radius: 15px; font-size: 0.8em; cursor: pointer; transition: all 0.2s ease; text-decoration: none; display: inline-block; }';
    echo '.btn-copy { background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white; }';
    echo '.btn-copy:hover { background: linear-gradient(135deg, #495057 0%, #343a40 100%); transform: translateY(-1px); }';
    echo '.btn-play { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; }';
    echo '.btn-play:hover { background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%); transform: translateY(-1px); }';
    // ç§»å¨ç«¯ååºå¼è®¾è®¡
    echo '@media (max-width: 768px) {';
    echo '  body { margin: 10px; }';
    echo '  .container { padding: 15px; margin: 5px; border-radius: 6px; box-sizing: border-box; }';
    echo '  h1 { font-size: 1.3em; }';
    echo '  .controls { flex-direction: column; gap: 8px; padding: 10px; box-sizing: border-box; }';
    echo '  .controls a { width: calc(100% - 4px); text-align: center; margin: 2px 0 !important; padding: 10px 12px; box-sizing: border-box; display: block; }';
    echo '  .controls span { width: 100%; text-align: center; margin: 5px 0 !important; padding: 5px; box-sizing: border-box; display: block; }';
    echo '  .stats { flex-direction: column; gap: 10px; padding: 15px; }';
    echo '  .stat-item { padding: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; }';
    echo '  .download-section { padding: 15px; margin: 15px 0; box-sizing: border-box; }';
    echo '  .download-section h4 { font-size: 1em; margin-bottom: 15px; }';
    echo '  .download-btn { width: calc(100% - 10px); margin: 5px 0; padding: 12px 15px; font-size: 0.9em; box-sizing: border-box; }';
    echo '  .iptv-table { font-size: 0.85em; }';
    echo '  .iptv-table th, .iptv-table td { padding: 8px 4px; }';
    echo '  .iptv-table th:first-child, .iptv-table td:first-child { width: 8%; text-align: center; }';
    echo '  .iptv-table th:nth-child(2), .iptv-table td:nth-child(2) { width: 35%; }';
    echo '  .iptv-table th:nth-child(3), .iptv-table td:nth-child(3) { display: none; }';
    echo '  .iptv-table th:nth-child(4), .iptv-table td:nth-child(4) { width: 57%; }';
    echo '  .action-buttons { flex-direction: column; gap: 3px; }';
    echo '  .btn { width: 100%; margin: 1px 0; padding: 8px 5px; font-size: 0.75em; box-sizing: border-box; }';
    echo '}';
    echo '@media (max-width: 480px) {';
    echo '  .container { margin: 2px; padding: 6px; box-sizing: border-box; }';
    echo '  h1 { font-size: 1.1em; margin-bottom: 10px; }';
    echo '  .controls { padding: 6px; gap: 5px; }';
    echo '  .controls a { width: calc(100% - 2px); padding: 8px 10px; font-size: 0.85em; margin: 1px 0 !important; }';
    echo '  .controls span { width: 100%; padding: 3px; font-size: 0.85em; margin: 2px 0 !important; }';
    echo '  .download-section { padding: 8px; margin: 10px 0; }';
    echo '  .download-btn { width: calc(100% - 6px); margin: 3px 0; padding: 10px 8px; font-size: 0.8em; box-sizing: border-box; }';
    echo '  .iptv-table { font-size: 0.75em; }';
    echo '  .iptv-table th, .iptv-table td { padding: 5px 2px; }';
    echo '  .btn { width: calc(100% - 4px); margin: 1px 0; padding: 6px 3px; font-size: 0.7em; box-sizing: border-box; }';
    echo '}';
    echo '</style>';
    echo '</head>';
    if (isset($_GET['channels'])) {
        echo '<body class="channels-page">';
    } else {
        echo '<body>';
    }
    echo '<div class="container">';
    //echo '<h1>ð IPTVè·åå·¥å·</h1>';
    echo '<h1><a href="' . $_SERVER['PHP_SELF'] . '" style="color: #61ABF5; text-decoration: none;">ð IPTVç¥å¨Pro</a></h1>';
    // è®¡æ°æ¾ç¤ºç§»è³é¦é¡µåºé¨
    // è®¡æ°æ¾ç¤ºç§»è³é¦é¡µåºé¨
    
    echo "<div class='controls'>";
    echo "<a href='" . $_SERVER['PHP_SELF'] . "' style='text-decoration: none; background: #007bff; color: white; padding: 8px 15px; border-radius: 4px;'>â è¿ååè¡¨</a>";
    echo "<span style='margin-left: 15px;'>æ¥è¯¢IP: <strong>{$s}</strong></span>";
    
    // æ·»å é¢éåè¡¨é¾æ¥
    if (!isset($_GET['channels'])) {
        echo "<a href='" . $_SERVER['PHP_SELF'] . "?s=" . urlencode($s) . "&channels=1' style='margin-left: 15px; background: #28a745; color: white; padding: 8px 15px; border-radius: 4px; text-decoration: none;'>ðº æ¥çé¢éåè¡¨</a>";
    } else {
        echo "<a href='" . $_SERVER['PHP_SELF'] . "?s=" . urlencode($s) . "' style='margin-left: 15px; background: #ffc107; color: #212529; padding: 8px 15px; border-radius: 4px; text-decoration: none;'>ð æ¥çåºç¡ä¿¡æ¯</a>";
    }
    echo "</div>";
    
    // å¦æè¯·æ±é¢éåè¡¨
    if (isset($_GET['channels'])) {
        require_once 'iptv_channels.php';
        
        // è·åé¢éåè¡¨
        $channelsResult = getIptvChannelList($s, false);
        
        if ($channelsResult['success']) {
            echo "<div class='group-section'>";
            echo "<h3 class='group-header proxy'>ðº é¢éåè¡¨</h3>";
            echo "<div style='padding: 20px;'>";
            
            if (isset($channelsResult['source_info'])) {
                $info = $channelsResult['source_info'];
                echo "<div class='stats' style='margin-bottom: 20px;'>";
                echo "<div class='stat-item'><span class='stat-number'>{$info['provider']}</span><span>æä¾å</span></div>";
                echo "<div class='stat-item'><span class='stat-number'>{$info['type']}</span><span>æºç±»å</span></div>";
                echo "<div class='stat-item'><span class='stat-number'>{$info['total_channels']}</span><span>æ»é¢éæ°</span></div>";
                echo "<div class='stat-item'><span class='stat-number'>{$info['total_found']}</span><span>æåè§£æ</span></div>";
                echo "</div>";
            }
            
            // æ·»å ä¸è½½æé®
            echo "<div class='download-section'>";
            echo "<h4>ð¾ ä¸è½½é¢éåè¡¨</h4>";
            echo "<a href='" . $_SERVER['PHP_SELF'] . "?s=" . urlencode($s) . "&channels=1&download=txt' ";
            echo "   class='download-btn txt' ";
            echo "   title='ä¸è½½TXTæ ¼å¼ï¼æ¯è¡æ ¼å¼ï¼é¢éåç§°,URL'>ð ä¸è½½TXTæä»¶</a>";
            echo "<a href='" . $_SERVER['PHP_SELF'] . "?s=" . urlencode($s) . "&channels=1&download=m3u' ";
            echo "   class='download-btn m3u' ";
            echo "   title='ä¸è½½M3Uæ ¼å¼ï¼æ åæ­æ¾åè¡¨'>ðµ ä¸è½½M3Uæä»¶</a>";
            echo "<p class='download-tip'>ð¡ ç¹å»æé®ç´æ¥ä¸è½½å¯¹åºæ ¼å¼çé¢éåè¡¨æä»¶</p>";
            echo "</div>";
            
            echo "<table class='iptv-table'>";
            echo "<thead><tr><th>åºå·</th><th>é¢éåç§°</th><th>M3U8å°å</th><th style='width: 200px;'>æä½</th></tr></thead>";
            echo "<tbody>";
            
            foreach ($channelsResult['data'] as $index => $channel) {
                echo "<tr>";
                echo "<td>" . ($index + 1) . "</td>";
                echo "<td><strong>" . htmlspecialchars($channel['name']) . "</strong></td>";
                echo "<td style='font-family: monospace; font-size: 0.85em; max-width: 300px; overflow: hidden; text-overflow: ellipsis; word-break: break-all;'>" . htmlspecialchars($channel['url']) . "</td>";
                echo "<td>";
                // æä½æé®
                echo "<div class='action-buttons'>";
                echo "<button onclick='copyToClipboard(\"" . htmlspecialchars($channel['url'], ENT_QUOTES) . "\")' class='btn btn-copy'>ð å¤å¶</button>";
                echo "<a href='player.html?url=" . urlencode($channel['url']) . "&name=" . urlencode($channel['name']) . "' target='_blank' class='btn btn-play'>ð¥ æ­æ¾</a>";
                echo "</div>";
                echo "</td>";
                echo "</tr>";
            }
            
            echo "</tbody></table>";
            echo "</div></div>";
        } else {
            echo "<div class='error'>";
            echo "<h4>â ï¸ æ æ³è·åé¢éåè¡¨</h4>";
            echo "<p>IPå°å: <strong>" . htmlspecialchars($s) . "</strong></p>";
            echo "<p>éè¯¯ä¿¡æ¯: " . htmlspecialchars($channelsResult['error'] ?? 'æªç¥éè¯¯') . "</p>";
            echo "<p style='margin-top: 15px;'>ð¡ å¯è½çåå ï¼</p>";
            echo "<ul style='margin-left: 20px;'>";
            echo "<li>è¯¥IPå°åå½åä¸å¯ç¨æç½ç»è¶æ¶</li>";
            echo "<li>æºç«ç¹å¯è½ä¸´æ¶è®¿é®åé</li>";
            echo "<li>IPå°åæ ¼å¼ä¸æ­£ç¡®</li>";
            echo "</ul>";
            $s_p = extractIP($s);
            echo "<p style='margin-top: 15px;'>";
            echo "<a href='" . $_SERVER['PHP_SELF'] . "?p=" . urlencode($s_p) . "' style='background: #007bff; color: white; padding: 8px 15px; border-radius: 4px; text-decoration: none;'>ð éæ°å°è¯åºç¡ä¿¡æ¯</a> ";
            echo "<a href='" . $_SERVER['PHP_SELF'] . "' style='background: #6c757d; color: white; padding: 8px 15px; border-radius: 4px; text-decoration: none; margin-left: 10px;'>ð è¿ååè¡¨</a>";
            echo "</p>";
            echo "</div>";
        }
        
        // æ·»å JavaScriptåè½
        echo "<script>";
        echo "function copyToClipboard(text) {";
        echo "  if (navigator.clipboard && navigator.clipboard.writeText) {";
        echo "    navigator.clipboard.writeText(text).then(function() {";
        echo "      showToast('å·²å¤å¶å°åªè´´æ¿: ' + text.substring(0, 50) + '...', 'success');";
        echo "    }).catch(function(err) {";
        echo "      fallbackCopyTextToClipboard(text);";
        echo "    });";
        echo "  } else {";
        echo "    fallbackCopyTextToClipboard(text);";
        echo "  }";
        echo "}";
        echo "";
        echo "function fallbackCopyTextToClipboard(text) {";
        echo "  const textArea = document.createElement('textarea');";
        echo "  textArea.value = text;";
        echo "  textArea.style.position = 'fixed';";
        echo "  textArea.style.top = '0';";
        echo "  textArea.style.left = '0';";
        echo "  textArea.style.width = '2em';";
        echo "  textArea.style.height = '2em';";
        echo "  textArea.style.padding = '0';";
        echo "  textArea.style.border = 'none';";
        echo "  textArea.style.outline = 'none';";
        echo "  textArea.style.boxShadow = 'none';";
        echo "  textArea.style.background = 'transparent';";
        echo "  document.body.appendChild(textArea);";
        echo "  textArea.focus();";
        echo "  textArea.select();";
        echo "  try {";
        echo "    const successful = document.execCommand('copy');";
        echo "    if (successful) {";
        echo "      showToast('å·²å¤å¶å°åªè´´æ¿', 'success');";
        echo "    } else {";
        echo "      showToast('å¤å¶å¤±è´¥ï¼è¯·æå¨å¤å¶', 'error');";
        echo "    }";
        echo "  } catch (err) {";
        echo "    showToast('å¤å¶å¤±è´¥: ' + err.message, 'error');";
        echo "  }";
        echo "  document.body.removeChild(textArea);";
        echo "}";
        echo "";
        echo "function showToast(message, type) {";
        echo "  const toast = document.createElement('div');";
        echo "  toast.textContent = message;";
        echo "  toast.style.position = 'fixed';";
        echo "  toast.style.top = '20px';";
        echo "  toast.style.right = '20px';";
        echo "  toast.style.padding = '12px 24px';";
        echo "  toast.style.borderRadius = '6px';";
        echo "  toast.style.color = 'white';";
        echo "  toast.style.fontWeight = 'bold';";
        echo "  toast.style.zIndex = '9999';";
        echo "  toast.style.maxWidth = '300px';";
        echo "  toast.style.wordWrap = 'break-word';";
        echo "  toast.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';";
        echo "  toast.style.background = (type === 'success') ? '#28a745' : '#dc3545';";
        echo "  document.body.appendChild(toast);";
        echo "  setTimeout(() => {";
        echo "    if (toast.parentNode) {";
        echo "      toast.parentNode.removeChild(toast);";
        echo "    }";
        echo "  }, 3000);";
        echo "}";
        echo "</script>";
    } else {
        // æ¾ç¤ºåºç¡ä¿¡æ¯
        require_once 'iptv_parser.php';
        $result = getHotelIptvInfo($s);
        
        if ($result['success'] && !empty($result['data'])) {
            $info = $result['data'][0];
            echo "<div class='group-section'>";
            echo "<h3 class='group-header proxy'>ð IPè¯¦ç»ä¿¡æ¯</h3>";
            echo "<div style='padding: 20px;'>";
            echo "<table class='iptv-table'>";
            echo "<tr><th>é¡¹ç®</th><th>å¼</th></tr>";
            echo "<tr><td>IPç«¯å£</td><td><strong>{$info['ip_port']}</strong></td></tr>";
            echo "<tr><td>é¢éæ°</td><td><strong style='color: #28a745;'>{$info['channel_count']}</strong></td></tr>";
            echo "<tr><td>ç±»å</td><td>{$info['source_type']}</td></tr>";
            echo "<tr><td>ä¸çº¿æ¶é´</td><td>{$info['online_time']}</td></tr>";
            
            $statusClass = (strpos($info['status'], 'æ°ä¸çº¿') !== false) ? 'status-new' : 
                          ((strpos($info['status'], 'å­æ´»') !== false) ? 'status-alive' : 'status-failed');
            echo "<tr><td>ç¶æ</td><td><span class='status-badge {$statusClass}'>{$info['status']}</span></td></tr>";
            echo "</table>";
            echo "</div></div>";
        } else {
            echo "<div style='color:red;background:#fee;padding:15px;border-radius:4px;'>æ æ³è·åIP {$s} çè¯¦ç»ä¿¡æ¯</div>";
        }
    }
    
    echo "<div style='text-align:center;margin-top:20px;padding-top:15px;border-top:1px solid #eee;color:#666;'>æ¥è¯¢å®æ</div>";
    echo "</div></body></html>";
    exit;
} else {
    // ä¸»é¡µé¢ - æ¾ç¤ºIPåè¡¨
    echo '<!DOCTYPE html>';
    echo '<html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>IPTVåè¡¨è§£æå¨ - å¤çº¿ç¨ç</title>';
    echo '<style>';
    echo 'body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }';
    echo '.container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }';
    echo 'h1 { color: #333; text-align: center; border-bottom: 3px solid #007bff; padding-bottom: 10px; }';
    echo '.controls { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; display: flex; align-items: center; flex-wrap: wrap; gap: 15px; }';
    echo '.controls label { font-weight: bold; color: #495057; }';
    echo '.controls select { padding: 6px 10px; border: 1px solid #ced4da; border-radius: 4px; background: white; font-size: 14px; }';
    echo '.controls select:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 2px rgba(0,123,255,0.25); }';
    echo '.controls button { background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }';
    echo '.controls button:hover { background: #218838; }';
    echo '.pill { background:#e9ecef; color:#333; padding:4px 8px; border-radius:12px; margin:2px; display:inline-block; }';
    echo '.stats { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-around; }';
    echo '.stat-item { text-align: center; }';
    echo '.stat-number { font-size: 1.5em; font-weight: bold; display: block; }';
    echo '.group-section { margin-bottom: 20px; border: 1px solid #ddd; border-radius: 5px; overflow: hidden; }';
    echo '.group-header { padding: 15px; font-weight: bold; color: white; margin: 0; }';
    echo '.group-header.proxy { background: #ff6b6b; }';
    echo '.group-header.hotel { background: #4ecdc4; }';
    echo '.group-header.multicast { background: #45b7d1; }';
    echo '.iptv-table { width: 100%; border-collapse: collapse; }';
    echo '.iptv-table th { background: #f8f9fa; padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6; }';
    echo '.iptv-table td { padding: 10px; border-bottom: 1px solid #dee2e6; }';
    echo '.iptv-table tr:hover { background: #f8f9fa; }';
    echo '.ip-link { color: #007bff; text-decoration: none; font-weight: 500; }';
    echo '.ip-link:hover { text-decoration: underline; }';
    echo '.status-badge { padding: 3px 6px; border-radius: 10px; font-size: 0.85em; }';
    echo '.status-new { background: #d4edda; color: #155724; }';
    echo '.status-alive { background: #fff3cd; color: #856404; }';
    echo '.status-failed { background: #f8d7da; color: #721c24; }';
    echo '.loading { text-align: center; padding: 30px; }';
    echo '.spinner { border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 15px; }';
    echo '@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
    echo '.error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 4px; margin: 20px 0; }';
    echo '.footer { text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; color: #666; }';
    echo '.performance-badge { background: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 10px; }';
    echo '.progress-bar { background: #e9ecef; border-radius: 10px; overflow: hidden; margin: 10px 0; }';
    echo '.progress-fill { background: linear-gradient(90deg, #007bff, #28a745); height: 20px; border-radius: 10px; transition: width 0.3s; color: white; text-align: center; line-height: 20px; font-size: 12px; }';
    
    // ç§»å¨ç«¯ååºå¼è®¾è®¡
    echo '@media (max-width: 768px) {';
    echo '  .container { margin: 10px; padding: 15px; }';
    echo '  h1 { font-size: 1.5em; }';
    echo '  .controls { flex-direction: column; gap: 10px; align-items: stretch; }';
    echo '  .controls label { margin-left: 0 !important; margin-bottom: 5px; }';
    echo '  .controls select, .controls button { width: 100%; margin-left: 0 !important; }';
    echo '  .stats { flex-direction: column; gap: 10px; }';
    echo '  .stat-item { padding: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; }';
    echo '  .iptv-table th:first-child, .iptv-table td:first-child { width: 25%; }';
    echo '  .iptv-table th:nth-child(2), .iptv-table td:nth-child(2) { width: 15%; text-align: center; }';
    echo '  .iptv-table th:nth-child(3), .iptv-table td:nth-child(3) { width: 25%; font-size: 0.8em; }';
    echo '  .iptv-table th:nth-child(4), .iptv-table td:nth-child(4) { width: 20%; font-size: 0.8em; }';
    echo '  .iptv-table th:last-child, .iptv-table td:last-child { width: 15%; }';
    echo '  .iptv-table th, .iptv-table td { padding: 8px 4px; font-size: 0.9em; }';
    echo '  .ip-link { font-size: 0.85em; word-break: break-all; }';
    echo '  .status-badge { font-size: 0.7em; padding: 2px 4px; }';
    echo '}';
    
    echo '@media (max-width: 480px) {';
    echo '  .container { margin: 5px; padding: 10px; }';
    echo '  h1 { font-size: 1.2em; }';
    echo '  .iptv-table th, .iptv-table td { padding: 6px 2px; font-size: 0.8em; }';
    echo '  .ip-link { font-size: 0.75em; }';
    echo '  .status-badge { font-size: 0.65em; padding: 1px 3px; }';
    echo '  .controls select, .controls button { padding: 8px; font-size: 0.9em; }';
    echo '  .performance-badge { font-size: 0.65em; padding: 2px 4px; }';
    echo '}';
    echo '</style>';
    echo '</head><body><div class="container">';
    //echo '<h1>ð IPTVè·åå·¥å· <span class="performance-badge">é«éç</span></h1>';
    //echo '<h1>ð IPTVè·åå·¥å· </h1>';
    echo '<h1><a href="' . $_SERVER['PHP_SELF'] . '" style="color: #61ABF5; text-decoration: none;">ð IPTVç¥å¨Pro</a></h1>';
    
    // æ£æ¥ç¼å­
    $cacheKey = 'iptv_cache_mt_' . $limit . '_' . $type . '_' . $province;
    $cacheTimeKey = 'cache_time_mt_' . $limit . '_' . $type . '_' . $province;
    $useCache = !$refresh && isset($_SESSION[$cacheKey]) && 
               (time() - ($_SESSION[$cacheTimeKey] ?? 0)) < 1800; // 30åéç¼å­
    
    // æ£æ¥æ¯å¦éè¦è§£æ
    $parseRequested = isset($_GET['parse']) && $_GET['parse'] == '1';
    
    echo '<div class="controls">';
    echo '<label>ç±»å:</label>';
    echo '<select id="typeSelect">';
    echo '<option value="all"' . ($type == 'all' ? ' selected' : '') . '>å¨é¨</option>';
    echo '<option value="proxy"' . ($type == 'proxy' ? ' selected' : '') . '>ä»£ç</option>';
    echo '<option value="hotel"' . ($type == 'hotel' ? ' selected' : '') . '>éåº</option>';
    echo '<option value="multicast"' . ($type == 'multicast' ? ' selected' : '') . '>ç»æ­</option>';
    echo '</select>';
    
    // çä»½éæ©
    echo '<label style="margin-left: 15px;">çä»½:</label>';
    echo '<select id="provinceSelect">';
    $provinces = [
        'all' => 'å¨é¨',
        'åäº¬' => 'åäº¬', 'ä¸æµ·' => 'ä¸æµ·', 'å¤©æ´¥' => 'å¤©æ´¥', 'éåº' => 'éåº',
        'æ²³å' => 'æ²³å', 'å±±è¥¿' => 'å±±è¥¿', 'è¾½å®' => 'è¾½å®', 'åæ' => 'åæ', 'é»é¾æ±' => 'é»é¾æ±',
        'æ±è' => 'æ±è', 'æµæ±' => 'æµæ±', 'å®å¾½' => 'å®å¾½', 'ç¦å»º' => 'ç¦å»º', 'æ±è¥¿' => 'æ±è¥¿', 'å±±ä¸' => 'å±±ä¸',
        'æ²³å' => 'æ²³å', 'æ¹å' => 'æ¹å', 'æ¹å' => 'æ¹å', 'å¹¿ä¸' => 'å¹¿ä¸', 'æµ·å' => 'æµ·å',
        'åå·' => 'åå·', 'è´µå·' => 'è´µå·', 'äºå' => 'äºå', 'éè¥¿' => 'éè¥¿', 'çè' => 'çè', 'éæµ·' => 'éæµ·',
        'å°æ¹¾' => 'å°æ¹¾', 'åèå¤' => 'åèå¤', 'å¹¿è¥¿' => 'å¹¿è¥¿', 'è¥¿è' => 'è¥¿è', 'å®å¤' => 'å®å¤', 'æ°ç' => 'æ°ç'
    ];
    foreach ($provinces as $key => $label) {
        echo '<option value="' . $key . '"' . ($province == $key ? ' selected' : '') . '>' . $label . '</option>';
    }
    echo '</select>';
    
    echo '<label style="margin-left: 15px;">æ¯ç»éå¶:</label>';
    echo '<select id="limitSelect">';
    // ä¿®æ¹éé¡¹ä¸º3,6,10
    echo '<option value="3"' . ($limit == 3 ? ' selected' : '') . '>3</option>';
    echo '<option value="6"' . ($limit == 6 ? ' selected' : '') . '>6</option>';
    echo '<option value="10"' . ($limit == 10 ? ' selected' : '') . '>10</option>';
    echo '<option value="20"' . ($limit == 20 ? ' selected' : '') . '>20</option>';
    echo '</select>';
    
    // æ·»å è§£ææé®
    echo '<button onclick="getIps()" style="margin-left: 15px; background: #17a2b8; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">ð§¾ è·åIP</button>';
    echo '<button onclick="parseData()" style="margin-left: 10px; background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">ð è§£ææ°æ®</button>';
    echo '<button onclick="refreshData()" style="margin-left: 10px;">ð å·æ°æ°æ®</button>';
    
    echo '<span style="margin-left: 15px; color: #666;">';
    $typeNames = ['all' => 'å¨é¨', 'proxy' => 'ä»£ç', 'hotel' => 'éåº', 'multicast' => 'ç»æ­'];
    echo $typeNames[$type] . ' - æ¯ç»æ¾ç¤º ' . $limit . ' ä¸ªIP';
    echo '</span>';
    echo '</div>';
    
    // æ°æ®è·åå¥å£
    require_once 'iptv_parser.php';
    
    $response = null;
    $httpCode = 200;
    $provinceMode = ($province !== 'all');
    
    if (!$provinceMode) {
        // è·åé¦é¡µï¼åé»è¾ï¼
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, 'https://tonkiang.us/hoteliptv2025.php');
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_TIMEOUT, 30);
        curl_setopt($ch, CURLOPT_HTTPHEADER, [
            'user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        ]);
        $response = curl_exec($ch);
        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        curl_close($ch);
    }
    
    // è§£æIPåç»å½æ°
    function extractIpsFromHtml($html, $groupName) {
        $pattern = '/<div[^>]*>[^<]*' . preg_quote($groupName) . '[^<]*<\/div>(.*?)(?=<div[^>]*>[^<]*(?:Proxy IPTV|Hotel IPTV|Multicast IP)|<div style="clear: both"><\/div>)/s';
        if (preg_match($pattern, $html, $match)) {
            preg_match_all('/hoteliptv2025\.php\?s=([^"\']+)/', $match[1], $matches);
            return array_unique($matches[1] ?? []);
        }
        return [];
    }
    
    // åç¬è·åIPæ¨¡å¼ï¼ä¸è§£æï¼ï¼ä»è¾åºIPï¼ä¸å¸¦ç«¯å£ï¼å¹¶åç»æ¾ç¤ºå°ä¸æ¹è¡¨æ ¼
    if ($getIps) {
        $keywordMap = [
            'åäº¬' => 'åäº¬å¸','ä¸æµ·' => 'ä¸æµ·å¸','å¤©æ´¥' => 'å¤©æ´¥å¸','éåº' => 'éåºå¸','æ²³å' => 'æ²³åç','å±±è¥¿' => 'å±±è¥¿ç','è¾½å®' => 'è¾½å®ç','åæ' => 'åæç','é»é¾æ±' => 'é»é¾æ±ç','æ±è' => 'æ±èç','æµæ±' => 'æµæ±ç','å®å¾½' => 'å®å¾½ç','ç¦å»º' => 'ç¦å»ºç','æ±è¥¿' => 'æ±è¥¿ç','å±±ä¸' => 'å±±ä¸ç','æ²³å' => 'æ²³åç','æ¹å' => 'æ¹åç','æ¹å' => 'æ¹åç','å¹¿ä¸' => 'å¹¿ä¸ç','æµ·å' => 'æµ·åç','åå·' => 'åå·ç','è´µå·' => 'è´µå·ç','äºå' => 'äºåç','éè¥¿' => 'éè¥¿ç','çè' => 'çèç','éæµ·' => 'éæµ·ç','å°æ¹¾' => 'å°æ¹¾ç','åèå¤' => 'åèå¤èªæ²»åº','å¹¿è¥¿' => 'å¹¿è¥¿æ°é»','è¥¿è' => 'è¥¿èèªæ²»åº','å®å¤' => 'å®å¤åæèªæ²»åº','æ°ç' => 'æ°çç»´å¾å°èªæ²»åº'
        ];
        $keyword = ($province !== 'all') ? ($keywordMap[$province] ?? $province) : '';
        $cnType = ($type === 'hotel') ? 'éåº' : (($type === 'multicast') ? 'ç»æ­' : (($type === 'proxy') ? 'ä»£ç' : null));
        $items = [];
        if ($province !== 'all') {
            for ($pg = 1; $pg <= 2; $pg++) {
                $r = searchIptvList($keyword, $cnType, $pg);
                if ($r && isset($r['success']) && $r['success'] && !empty($r['data'])) {
                    $items = array_merge($items, $r['data']);
                }
            }
        } else {
            if (!$response && !$provinceMode) {
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_URL, 'https://tonkiang.us/hoteliptv2025.php');
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
                curl_setopt($ch, CURLOPT_TIMEOUT, 30);
                curl_setopt($ch, CURLOPT_HTTPHEADER, [ 'user-agent: Mozilla/5.0' ]);
                $response = curl_exec($ch);
                curl_close($ch);
            }
            if ($response) {
                $groupsRaw = [
                    'proxy' => extractIpsFromHtml($response, 'Proxy IPTV'),
                    'hotel' => extractIpsFromHtml($response, 'Hotel IPTV'),
                    'multicast' => extractIpsFromHtml($response, 'Multicast IP')
                ];
                $pick = ($type === 'all') ? array_merge($groupsRaw['proxy'], $groupsRaw['hotel'], $groupsRaw['multicast']) : ($groupsRaw[$type] ?? []);
                foreach (array_slice($pick, 0, $limit) as $ip) { $items[] = ['ip_port' => $ip, 'source_type' => 'æªç¥']; }
            }
        }
        // å»éï¼ä»ä¿çIPï¼ä¸å¸¦ç«¯å£
        $uniqueIps = [];
        foreach ($items as $it) {
            $ipOnly = preg_replace('/:.*/', '', $it['ip_port']);
            $uniqueIps[$ipOnly] = true;
        }
        $_SESSION['fetched_ips_mt'] = array_keys($uniqueIps);

        // æé ä¸âæªè§£æâè§å¾ä¸è´çæ°æ®ç»æï¼æç±»ååç»ï¼åªæ¾ç¤ºIP
        $results = ['success' => true, 'data' => []];
        $groupsInit = ['proxy' => [], 'hotel' => [], 'multicast' => []];
        if ($province !== 'all') {
            // åºäºè¿åé¡¹çsource_typeè¿è¡åç»
            foreach ($items as $it) {
                $ipOnly = preg_replace('/:.*/', '', $it['ip_port']);
                if (!isset($uniqueIps[$ipOnly])) continue; // å®å¨é²é
                $st = $it['source_type'] ?? '';
                $gk = 'proxy';
                if (preg_match('/éåº/u', $st)) { $gk = 'hotel'; }
                elseif (preg_match('/ç»æ­|çµæ­/u', $st)) { $gk = 'multicast'; }
                elseif (preg_match('/ä»£ç/u', $st)) { $gk = 'proxy'; }
                if (!isset($groupsInit[$gk])) $groupsInit[$gk] = [];
                if (!isset($results['data'][$gk])) $results['data'][$gk] = [];
                if (count($results['data'][$gk]) < $limit) {
                    $results['data'][$gk][$ipOnly] = [
                        'ip_port' => $ipOnly,
                        'channel_count' => 'æªè§£æ',
                        'source_type' => 'æªè§£æ',
                        'online_time' => 'æªè§£æ',
                        'status' => 'æªè§£æ'
                    ];
                }
            }
        } else {
            foreach ($_SESSION['fetched_ips_mt'] as $ipOnly) {
                $bucket = ($type === 'all') ? 'proxy' : $type; // ç®åå½ç±»
                if (!isset($results['data'][$bucket])) $results['data'][$bucket] = [];
                if (count($results['data'][$bucket]) < $limit) {
                    $results['data'][$bucket][$ipOnly] = [
                        'ip_port' => $ipOnly,
                        'channel_count' => 'æªè§£æ',
                        'source_type' => 'æªè§£æ',
                        'online_time' => 'æªè§£æ',
                        'status' => 'æªè§£æ'
                    ];
                }
            }
        }
        if ($type !== 'all') {
            $results['data'] = isset($results['data'][$type]) ? [$type => ($results['data'][$type] ?? [])] : [];
        }
    }

    if ($parseRequested) {
        // æ§è¡è§£æ
        if (!$useCache) {
            echo '<div class="loading" id="loading">';
            echo '<div class="spinner"></div>';
            echo '<p>ð æ°æ®è§£æä¸­ï¼è¯·ç¨å...</p>';
            echo '<p style="font-size: 0.9em; color: #999;">æ­£å¨è·åææ°çIPTVæºä¿¡æ¯ï¼å¤çº¿ç¨å éå¤çä¸­</p>';
            echo '<div class="progress-bar">';
            echo '<div class="progress-fill" id="progressBar" style="width: 0%;">åå¤ä¸­...</div>';
            echo '</div>';
            echo '</div>';
            
            // å¤çº¿ç¨IPè§£æå½æ°
            function parseIpsMultiThread($ips, $maxConcurrent = 5) {
                $results = [];
                $chunks = array_chunk($ips, $maxConcurrent);
                
                foreach ($chunks as $chunk) {
                    $multiHandle = curl_multi_init();
                    $curlHandles = [];
                    
                    foreach ($chunk as $ip) {
                        $ch = curl_init();
                        curl_setopt($ch, CURLOPT_URL, 'https://tonkiang.us/hoteliptv2025.php?s=' . urlencode($ip));
                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
                        curl_setopt($ch, CURLOPT_TIMEOUT, 15);
                        curl_setopt($ch, CURLOPT_HTTPHEADER, [
                            'user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                        ]);
                        
                        curl_multi_add_handle($multiHandle, $ch);
                        $curlHandles[$ip] = $ch;
                    }
                    
                    $running = null;
                    do {
                        curl_multi_exec($multiHandle, $running);
                        curl_multi_select($multiHandle);
                    } while ($running > 0);
                    
                    foreach ($curlHandles as $ip => $ch) {
                        $response = curl_multi_getcontent($ch);
                        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
                        
                        if ($response && $httpCode === 200) {
                            $info = parseIptvResponse($response, $ip);
                            $results[$ip] = $info;
                        } else {
                            $results[$ip] = [
                                'ip_port' => $ip,
                                'channel_count' => 'æªç¥',
                                'source_type' => 'æªç¥',
                                'online_time' => 'æªç¥',
                                'status' => 'è§£æå¤±è´¥'
                            ];
                        }
                        
                        curl_multi_remove_handle($multiHandle, $ch);
                        curl_close($ch);
                    }
                    
                    curl_multi_close($multiHandle);
                }
                
                return $results;
            }
            
            function parseIptvResponse($html, $ip) {
                $ipPort = $ip;
                if (preg_match('/hotellist\.html\?s=([\d\.:]+)/', $html, $matches)) {
                    $ipPort = $matches[1];
                }
                
                $channelCount = 'æªç¥';
                if (preg_match('/é¢éæ°ï¼.*?<span[^>]*><b>(\d+)<\/b><\/span>/', $html, $matches)) {
                    $channelCount = $matches[1];
                } elseif (preg_match('/é¢éæ°[ï¼:][^0-9]*(\d+)/', $html, $matches)) {
                    $channelCount = $matches[1];
                }
                
                $statusText = 'æªç¥';
                if (preg_match('/æ°ä¸çº¿/', $html)) {
                    $statusText = 'æ°ä¸çº¿';
                } elseif (preg_match('/å­æ´».*?<span[^>]*><b>(\d+)<\/b><\/span>/', $html, $matches)) {
                    $statusText = 'å­æ´»' . $matches[1] . 'å¤©';
                }
                
                $onlineTime = 'æªç¥';
                if (preg_match('/(\d{4}-\d{2}-\d{2} \d{2}:\d{2})ä¸çº¿/', $html, $matches)) {
                    $onlineTime = $matches[1];
                }
                
                $sourceType = 'æªç¥';
                if (preg_match('/ä¸çº¿\s*(.+?)\s*<\/i>/', $html, $matches)) {
                    $sourceType = trim(strip_tags($matches[1]));
                }
                
                return [
                    'ip_port' => $ipPort,
                    'channel_count' => $channelCount,
                    'online_time' => $onlineTime,
                    'source_type' => $sourceType,
                    'status' => $statusText
                ];
            }
            
            if ($provinceMode) {
                // çä»½æ¨¡å¼ï¼ç´æ¥ç¨æç´¢æ¥å£1-3é¡µå¹¶æé ç»æ
                $keywordMap = [
                    'åäº¬' => 'åäº¬å¸','ä¸æµ·' => 'ä¸æµ·å¸','å¤©æ´¥' => 'å¤©æ´¥å¸','éåº' => 'éåºå¸','æ²³å' => 'æ²³åç','å±±è¥¿' => 'å±±è¥¿ç','è¾½å®' => 'è¾½å®ç','åæ' => 'åæç','é»é¾æ±' => 'é»é¾æ±ç','æ±è' => 'æ±èç','æµæ±' => 'æµæ±ç','å®å¾½' => 'å®å¾½ç','ç¦å»º' => 'ç¦å»ºç','æ±è¥¿' => 'æ±è¥¿ç','å±±ä¸' => 'å±±ä¸ç','æ²³å' => 'æ²³åç','æ¹å' => 'æ¹åç','æ¹å' => 'æ¹åç','å¹¿ä¸' => 'å¹¿ä¸ç','æµ·å' => 'æµ·åç','åå·' => 'åå·ç','è´µå·' => 'è´µå·ç','äºå' => 'äºåç','éè¥¿' => 'éè¥¿ç','çè' => 'çèç','éæµ·' => 'éæµ·ç','å°æ¹¾' => 'å°æ¹¾ç','åèå¤' => 'åèå¤èªæ²»åº','å¹¿è¥¿' => 'å¹¿è¥¿æ°é»','è¥¿è' => 'è¥¿èèªæ²»åº','å®å¤' => 'å®å¤åæèªæ²»åº','æ°ç' => 'æ°çç»´å¾å°èªæ²»åº'
                ];
                $keyword = isset($keywordMap[$province]) ? $keywordMap[$province] : $province;
                $cnType = ($type === 'hotel') ? 'éåº' : (($type === 'multicast') ? 'ç»æ­' : (($type === 'proxy') ? 'ä»£ç' : null));
                $items = [];
                for ($pg = 1; $pg <= 2; $pg++) {
                    $r = searchIptvList($keyword, $cnType, $pg);
                    if ($r && isset($r['success']) && $r['success'] && !empty($r['data'])) {
                        $items = array_merge($items, $r['data']);
                    }
                }
                // æé åç»
                $groups = ['proxy' => [], 'hotel' => [], 'multicast' => []];
                foreach ($items as $it) {
                    $gk = 'proxy';
                    $st = $it['source_type'] ?? '';
                    if (preg_match('/éåº/u', $st)) { $gk = 'hotel'; }
                    elseif (preg_match('/ç»æ­|çµæ­/u', $st)) { $gk = 'multicast'; }
                    elseif (preg_match('/ä»£ç/u', $st)) { $gk = 'proxy'; }
                    if (count($groups[$gk]) < $limit) {
                        $ipOnly = preg_replace('/:.*/', '', $it['ip_port']);
                        $groups[$gk][] = $ipOnly; // ä»ä½¿ç¨IP
                    }
                }
                if ($type !== 'all') {
                    $groups = isset($groups[$type]) ? [$type => $groups[$type]] : [];
                }
            } else {
                $groups = [
                    'proxy' => array_slice(extractIpsFromHtml($response, 'Proxy IPTV'), 0, $limit),
                    'hotel' => array_slice(extractIpsFromHtml($response, 'Hotel IPTV'), 0, $limit),
                    'multicast' => array_slice(extractIpsFromHtml($response, 'Multicast IP'), 0, $limit)
                ];
                if ($type !== 'all') {
                    $filteredGroups = [];
                    if (isset($groups[$type])) { $filteredGroups[$type] = $groups[$type]; }
                    $groups = $filteredGroups;
                }
            }
            
            // å¦æä¹åéè¿âè·åIPâå·²ä¿å­åè¡¨ï¼åä¼åè§£æè¯¥åè¡¨
            if (!empty($_SESSION['fetched_ips_mt']) && is_array($_SESSION['fetched_ips_mt'])) {
                $selectedIps = array_slice($_SESSION['fetched_ips_mt'], 0, max(1, $limit));
                $groups = [$type === 'all' ? 'proxy' : $type => $selectedIps];
                // æ¸çä¿å­çåè¡¨ï¼é¿åä¸æ¬¡è¯¯ç¨ï¼
                unset($_SESSION['fetched_ips_mt']);
            }

            // å¤çº¿ç¨è§£æè¯¦ç»ä¿¡æ¯
            $results = ['success' => true, 'data' => []];
            $startTime = time();
            
            foreach ($groups as $groupName => $ips) {
                if (!empty($ips)) {
                    $results['data'][$groupName] = parseIpsMultiThread($ips, 5);
                } else {
                    $results['data'][$groupName] = [];
                }
            }
            
            $endTime = time();
            
            // ç¼å­ç»æ
            $_SESSION[$cacheKey] = $results;
            $_SESSION[$cacheTimeKey] = time();
            
            echo '<script>';
            echo 'document.getElementById("loading").style.display = "none";';
            echo '</script>';
        } else {
            $results = $_SESSION[$cacheKey];
        }
    } else {
        // åªæ¾ç¤ºIPåç»ï¼ä¸è§£æ
        if ($provinceMode) {
            $keywordMap = [
                'åäº¬' => 'åäº¬å¸','ä¸æµ·' => 'ä¸æµ·å¸','å¤©æ´¥' => 'å¤©æ´¥å¸','éåº' => 'éåºå¸','æ²³å' => 'æ²³åç','å±±è¥¿' => 'å±±è¥¿ç','è¾½å®' => 'è¾½å®ç','åæ' => 'åæç','é»é¾æ±' => 'é»é¾æ±ç','æ±è' => 'æ±èç','æµæ±' => 'æµæ±ç','å®å¾½' => 'å®å¾½ç','ç¦å»º' => 'ç¦å»ºç','æ±è¥¿' => 'æ±è¥¿ç','å±±ä¸' => 'å±±ä¸ç','æ²³å' => 'æ²³åç','æ¹å' => 'æ¹åç','æ¹å' => 'æ¹åç','å¹¿ä¸' => 'å¹¿ä¸ç','æµ·å' => 'æµ·åç','åå·' => 'åå·ç','è´µå·' => 'è´µå·ç','äºå' => 'äºåç','éè¥¿' => 'éè¥¿ç','çè' => 'çèç','éæµ·' => 'éæµ·ç','å°æ¹¾' => 'å°æ¹¾ç','åèå¤' => 'åèå¤èªæ²»åº','å¹¿è¥¿' => 'å¹¿è¥¿æ°é»','è¥¿è' => 'è¥¿èèªæ²»åº','å®å¤' => 'å®å¤åæèªæ²»åº','æ°ç' => 'æ°çç»´å¾å°èªæ²»åº'
            ];
            $keyword = isset($keywordMap[$province]) ? $keywordMap[$province] : $province;
            $cnType = ($type === 'hotel') ? 'éåº' : (($type === 'multicast') ? 'ç»æ­' : (($type === 'proxy') ? 'ä»£ç' : null));
            $items = [];
            for ($pg = 1; $pg <= 2; $pg++) {
                $r = searchIptvList($keyword, $cnType, $pg);
                if ($r && isset($r['success']) && $r['success'] && !empty($r['data'])) {
                    $items = array_merge($items, $r['data']);
                }
            }
            // æé ç»æ
            $results = ['success' => true, 'data' => []];
            $groups = ['proxy' => [], 'hotel' => [], 'multicast' => []];
            foreach ($items as $it) {
                $gk = 'proxy';
                $st = $it['source_type'] ?? '';
                if (preg_match('/éåº/u', $st)) { $gk = 'hotel'; }
                elseif (preg_match('/ç»æ­|çµæ­/u', $st)) { $gk = 'multicast'; }
                elseif (preg_match('/ä»£ç/u', $st)) { $gk = 'proxy'; }
                if (!isset($results['data'][$gk])) { $results['data'][$gk] = []; }
                if (count($results['data'][$gk]) < $limit) {
                    $ipOnly = preg_replace('/:.*/', '', $it['ip_port']);
                    $results['data'][$gk][$ipOnly] = [
                        'ip_port' => $ipOnly,
                        'channel_count' => $it['channel_count'] ?? 'æªç¥',
                        'source_type' => $it['source_type'] ?? 'æªç¥',
                        'online_time' => $it['online_time'] ?? 'æªç¥',
                        'status' => $it['status'] ?? 'æªç¥',
                    ];
                }
            }
            if ($type !== 'all') {
                $results['data'] = isset($results['data'][$type]) ? [$type => $results['data'][$type]] : [];
            }
        } else {
            if ($response && $httpCode === 200) {
                $groups = [
                    'proxy' => array_slice(extractIpsFromHtml($response, 'Proxy IPTV'), 0, $limit),
                    'hotel' => array_slice(extractIpsFromHtml($response, 'Hotel IPTV'), 0, $limit),
                    'multicast' => array_slice(extractIpsFromHtml($response, 'Multicast IP'), 0, $limit)
                ];
                if ($type !== 'all') {
                    $filteredGroups = [];
                    if (isset($groups[$type])) { $filteredGroups[$type] = $groups[$type]; }
                    $groups = $filteredGroups;
                }
                $results = ['success' => true, 'data' => []];
                foreach ($groups as $groupName => $ips) {
                    if (!empty($ips)) {
                        foreach ($ips as $ip) {
                            $results['data'][$groupName][$ip] = [
                                'ip_port' => $ip,
                                'channel_count' => 'æªè§£æ',
                                'source_type' => 'æªè§£æ',
                                'online_time' => 'æªè§£æ',
                                'status' => 'æªè§£æ'
                            ];
                        }
                    }
                }
            } else {
                $results = ['success' => false, 'error' => 'æ æ³è·åé¦é¡µæ°æ®'];
            }
        }
    }
    
    // æ¾ç¤ºç»æ
    if ($results['success']) {
        // è®¡ç®ç»è®¡ä¿¡æ¯
        $totalIps = 0;
        $successfulParses = 0;
        $failedParses = 0;
        
        foreach ($results['data'] as $groupData) {
            foreach ($groupData as $info) {
                $totalIps++;
                if ($info['status'] === 'è§£æå¤±è´¥') {
                    $failedParses++;
                } else {
                    $successfulParses++;
                }
            }
        }
        
        echo '<div class="stats">';
        echo '<div class="stat-item">';
        echo '<span class="stat-number">' . $totalIps . '</span>';
        echo '<span>æ»IPæ°é</span>';
        echo '</div>';
        echo '<div class="stat-item">';
        echo '<span class="stat-number">' . $successfulParses . '</span>';
        echo '<span>æåè§£æ</span>';
        echo '</div>';
        echo '<div class="stat-item">';
        echo '<span class="stat-number">' . $failedParses . '</span>';
        echo '<span>è§£æå¤±è´¥</span>';
        echo '</div>';
        echo '<div class="stat-item">';
        echo '<span class="stat-number">â¡</span>';
        echo '<span>è·åå é</span>';
        echo '</div>';
        echo '</div>';
        
        $groupNames = [
            'proxy' => ['name' => 'Proxy IPTV', 'class' => 'proxy', 'icon' => 'ð'],
            'hotel' => ['name' => 'Hotel IPTV', 'class' => 'hotel', 'icon' => 'ð¨'], 
            'multicast' => ['name' => 'Multicast IP', 'class' => 'multicast', 'icon' => 'ð¡']
        ];
        
        foreach ($results['data'] as $groupKey => $groupData) {
            if (empty($groupData)) continue;
            $group = $groupNames[$groupKey];
            
            echo '<div class="group-section">';
            echo '<h3 class="group-header ' . $group['class'] . '">';
            echo $group['icon'] . ' ' . $group['name'] . ' ';
            echo '<span style="font-weight: normal;">(' . count($groupData) . ' ä¸ª)</span>';
            //echo '<span class="performance-badge">å¤çº¿ç¨è§£æ</span>';
            echo '</h3>';
            echo '<div style="padding: 20px;">';
            echo '<table class="iptv-table">';
            echo '<thead>';
            echo '<tr>';
            echo '<th>IPç«¯å£</th>';
            echo '<th>é¢éæ°</th>';
            echo '<th>ç±»å</th>';
            echo '<th>ä¸çº¿æ¶é´</th>';
            echo '<th>ç¶æ</th>';
            echo '</tr>';
            echo '</thead>';
            echo '<tbody>';
            
            foreach ($groupData as $ip => $info) {
                echo '<tr>';
                echo '<td>';
                // ä¿®æ¹é¾æ¥é»è¾ï¼æ ¹æ®è§£æç¶æä½¿ç¨ä¸åçåæ°
                if ($parseRequested) {
                    // å·²è§£æï¼ä½¿ç¨såæ°
                    echo '<a href="' . $_SERVER['PHP_SELF'] . '?s=' . urlencode($info['ip_port']) . '" ';
                    echo '   class="ip-link" title="æ¥çè¯¦ç»ä¿¡æ¯">';
                    echo htmlspecialchars($info['ip_port']);
                    echo '</a>';
                } else {
                    // æªè§£æï¼ä½¿ç¨påæ°
                    echo '<a href="' . $_SERVER['PHP_SELF'] . '?p=' . urlencode($ip) . '" ';
                    echo '   target="_blank" class="ip-link" title="ç¹å»è§£æå¹¶æ¥çè¯¦ç»ä¿¡æ¯">';
                    echo htmlspecialchars($ip);
                    echo '</a>';
                }
                echo '</td>';
                echo '<td><strong style="color: #28a745;">' . htmlspecialchars($info['channel_count']) . '</strong></td>';
                echo '<td>' . htmlspecialchars($info['source_type']) . '</td>';
                echo '<td>' . htmlspecialchars($info['online_time']) . '</td>';
                echo '<td>';
                
                $status = $info['status'];
                $statusClass = (strpos($status, 'æ°ä¸çº¿') !== false) ? 'status-new' : 
                              ((strpos($status, 'å­æ´»') !== false) ? 'status-alive' : 'status-failed');
                
                echo '<span class="status-badge ' . $statusClass . '">';
                echo htmlspecialchars($status);
                echo '</span>';
                echo '</td>';
                echo '</tr>';
            }
            
            echo '</tbody>';
            echo '</table>';
            echo '</div>';
            echo '</div>';
        }
    } else {
        echo '<div class="error">';
        echo 'è§£æå¤±è´¥: ' . htmlspecialchars($results['error'] ?? 'æªç¥éè¯¯');
        echo '</div>';
    }
    
    echo '<div class="footer">';
    echo '<p>ð ç¹å»IPç«¯å£å¯æ¥çè¯¦ç»ä¿¡æ¯ | æ°æ®æ¥æº: ç½ç» | <span class="performance-badge">IPTV Pro</span></p>';
    echo '<p style="font-size: 0.85em;">';
    echo 'æåæ´æ°: ' . date('Y-m-d H:i:s', $_SESSION[$cacheTimeKey] ?? time());
    echo ' | <a href="' . $_SERVER['PHP_SELF'] . '?refresh=1&limit=' . $limit . '&type=' . $type . '" style="color: #007bff;">å¼ºå¶å·æ°</a>';
    echo ' | ð¡ by cqshushu @å¬ä¼å· å»å·¥å­¦ä¹ æ¥å¿';
    echo '</p>';
    echo '<p style="font-size: 0.85em; color:#666;">APIè°ç¨æ¬¡æ°ï¼' . number_format($callCount) . '</p>';
    echo '</div>';
    echo '</div>'; // ç»æ container
    
    echo '<script>';
    echo 'function updateParams() {';
    echo '    const limit = document.getElementById("limitSelect").value;';
    echo '    const type = document.getElementById("typeSelect").value;';
    echo '    const province = document.getElementById("provinceSelect").value;';
    echo '    window.location.href = "' . $_SERVER['PHP_SELF'] . '?limit=" + limit + "&type=" + type + "&province=" + encodeURIComponent(province);';
    echo '}';
    echo '';
    echo 'function refreshData() {';
    echo '    const limit = document.getElementById("limitSelect").value;';
    echo '    const type = document.getElementById("typeSelect").value;';
    echo '    const province = document.getElementById("provinceSelect").value;';
    echo '    window.location.href = "' . $_SERVER['PHP_SELF'] . '?refresh=1&limit=" + limit + "&type=" + type + "&province=" + encodeURIComponent(province);';
    echo '}';
    echo '';
    echo 'function parseData() {';
    echo '    const limit = document.getElementById("limitSelect").value;';
    echo '    const type = document.getElementById("typeSelect").value;';
    echo '    const province = document.getElementById("provinceSelect").value;';
    echo '    window.location.href = "' . $_SERVER['PHP_SELF'] . '?parse=1&limit=" + limit + "&type=" + type + "&province=" + encodeURIComponent(province);';
    echo '}';
    echo 'function getIps() {';
    echo '    const limit = document.getElementById("limitSelect").value;';
    echo '    const type = document.getElementById("typeSelect").value;';
    echo '    const province = document.getElementById("provinceSelect").value;';
    echo '    window.location.href = "' . $_SERVER['PHP_SELF'] . '?getips=1&limit=" + limit + "&type=" + type + "&province=" + encodeURIComponent(province);';
    echo '}';
    echo '';
    echo '// æ¨¡æè¿åº¦æ¡æ´æ°ï¼ä»å¨å è½½æ¶æ¾ç¤ºï¼';
    echo 'if (document.getElementById("progressBar")) {';
    echo '    let progress = 0;';
    echo '    const interval = setInterval(() => {';
    echo '        progress += Math.random() * 15;';
    echo '        if (progress >= 100) {';
    echo '            progress = 100;';
    echo '            clearInterval(interval);';
    echo '        }';
    echo '        const progressBar = document.getElementById("progressBar");';
    echo '        if (progressBar) {';
    echo '            progressBar.style.width = progress + "%";';
    echo '            progressBar.textContent = Math.floor(progress) + "%";';
    echo '        }';
    echo '    }, 500);';
    echo '}';
    echo '</script>';
    echo '</body></html>';
}
?>